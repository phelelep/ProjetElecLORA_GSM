# üìù Compte Rendu ‚Äî CEBAN Daniel  
## S√©ance du 12/11/2025

---

## Problematique 

- Impossible de redemarer le modem de la carte GSM7000 

---

## üéØ Objectifs de la s√©ance
- Correction du c√¢blage et du code pour pouvoir redemarer et √©tablier la communication **ESP32** avec le module **SIM7000G**
- Ameliorer le code existant 

---

## Etapes de la seance 

### Etape 1 : Recablage 

Le but c'est le trouver les bons pins GPIO pour etablier la communication 


![Erreur r√©demarrage modem](../Images/errorModemRestart.png)  


Conflit de broches PIN_RX = 21 et PIN_TX = 23.

En regardant le datasheet on utilise broche GPIO21 est directement connect√©e √† OLED_SDA.

Le probl√®me est que GPIO21 est utilis√© en interne par la carte pour contr√¥ler l'√©cran OLED via le protocole I2C.


On va changer √† nouveau le broches de PIN_RX et PIN_TX pour utiliser GPIO4 et GPIO17.

La configuration devient 

```
#define UART_BAUD   115200
#define PIN_DTR     25
#define PIN_RX      16   
#define PIN_TX      17  
#define PWR_KEY     13
```


#### Resultat 
**Success** cette fois on arrive a r√©demarrer le modem et recevoir certains donnes comme le nom du modem et infos du modem

Ici certains donnes pertinenetes qu'on arrive √† extraite vie le **Serial Monitor**

```text
IMEI : 869951037002734
Op√©rateur : F SFR
IP locale : 3915400804
Qualit√© du signal : 18
+CPSI: GSM,Online,208-10,0xc29b,16548,87 EGSM 900,-77,0,29-35
GPRS d√©connect√©
SMS Ready
```

On a aussi une partie qui fait un test **GPRS**

![R√©demarrage du modem SIM7000 r√©ussi](../Images/SuccessModem.png) 

```text
---D√âBUT DU TEST GPRS---

Connexion √† : sl2sfr
AT+CIPSHUT
```

et on arrive a recevoir un **SMS** sur mon portale personnel

![Message du modem re√ßu](../Images/ReceptionMessage.png) 

On en conclut donc que le code fonctionne. Et maintenant, il faut donc comprendre plus en d√©tail le fonctionnement du code, l'optimiser et essayer d'envoyer des donn√©es plus cons√©quentes.

---

### Etape 2 : Analyse du code

```
modem.sendAT("+CFUN=0 "); //Envoie la commande au modem pour le placer en mode Minimum Functionality 
res = modem.setNetworkMode(2); // mode automatique
modem.sendAT("+CFUN=1 "); //Fonctionnalit√© Compl√®te
SerialAT.println("AT+CGDCONT?"); // demande de PDP
```

#### Explication des PDP

PDP est un ensemble de param√®tres de configuration n√©cessaires pour √©tablir une connexion de donn√©es GPRS/LTE
permet au programmeur de v√©rifier la configuration r√©seau avant d‚Äô√©tablir une connexion de donn√©e
il garantit la configuration de l'APN 


**APN** - Access Point Name . C'est un param√®tre essentiel qui permet au SIM7000 d'√©tablir une connexion au r√©seau de donn√©es mobiles (GPRS, 3G, 4G, LTE, etc.)

dans notre code on a un bloc de code qui s'assure bien que la configuration APN √† √©t√© faire et que la connexion au r√©seau GPRS √† √©t√© bien √©tablie.


**GPRS** - General Packet Radio Service est une technologie de communication mobile qui repr√©sente la 2.5G . Il est consid√©r√© comme un service de donn√©es par paquets, ce qui signifie qu'il est la premi√®re √©tape dans l'√©volution des r√©seaux mobiles √† offrir un acc√®s "toujours connect√©" √† l'internet .

Caract√©ristiques
- Efficacit√© : Les donn√©es sont divis√©es en petits paquets et envoy√©es uniquement lorsque cela est n√©cessaire.
- Facturation : La facturation se fait g√©n√©ralement au volume de donn√©es transf√©r√©
- Toujours Connect√© (Always On)
- D√©bits relativement lents < 171,2 kbps 


On fait la deconnexion du GPRS avant d'envoier le SMS - pourquoi ? 
```
  modem.gprsDisconnect();
  if (!modem.isGprsConnected()) 
  {
    Serial.println("GPRS d√©connect√©");
  } else 
  {
    Serial.println("D√©connexion GPRS : √âchec");
  }

  // --------TEST ENVOI SMS--------
  res = modem.sendSMS(SMS_TARGET, String("Salut de la part de ") + imei);
  DBG("SMS:", res ? "Envoy√©" : "√âchec");
```

- SMS (Short Message Service) utilise traditionnellement le mode commutation de circuits sur le r√©seau GSM/2G.

- GPRS (General Packet Radio Service) utilise le mode commutation de paquets pour la transmission de donn√©es Internet.

Pourquoi ? 

- Bien que les modems modernes (comme le SIM7000) puissent g√©rer les deux simultan√©ment dans certaines conditions, de nombreux modems GSM/GPRS plus anciens ou les configurations par d√©faut requi√®rent que la couche radio soit d√©di√©e √† un seul type de t√¢che pour la fiabilit√©. En d√©connectant explicitement la session GPRS (paquets), on s'assure que le modem est dans un √©tat optimal pour se concentrer sur l'√©tablissement et l'envoi du message de signalisation SMS.

- Lib√©rer les ressources : D√©connecter le GPRS permet de lib√©rer des ressources internes du modem (m√©moire, connexions de donn√©es) et l'adresse IP qui lui √©tait allou√©e.

- Fiabilit√© de l'envoi : Dans certains cas, tenter d'envoyer un SMS (qui est prioritaire sur les r√©seaux) pendant qu'une session GPRS est active peut provoquer un conflit ou un √©chec de l'envoi du SMS. D√©connecter la session GPRS rend le modem plus r√©actif pour les t√¢ches non-GPRS, comme l'envoi de SMS.


| Caract√©ristique           | GPRS/LTE (Cellulaire)                                | LoRa (Long Range)                                         |
|----------------------------|------------------------------------------------------|-----------------------------------------------------------|
| **Objectif Principal**     | Acc√®s √† l'Internet Public (WAN)                      | R√©seau Local et Priv√© (PAN ou LAN)                        |
| **Couverture**             | Nationale/Mondiale (via op√©rateurs)                  | Locale (quelques km)                                      |
| **D√©bit**                  | Moyen √† lent (jusqu'√† 171 kbps)                      | Tr√®s lent (quelques centaines de bits/seconde)            |
| **R√¥le dans l'IoT**        | La liaison de retour vers le Cloud/Serveur.          | La liaison de collecte des donn√©es des capteurs.          |



Dans l'√©tat actuel de notre code: 

1. Le GPRS est utilis√© pour v√©rifier que le modem est capable d'√©tablir une connexion de donn√©es √† Internet en utilisant le r√©seau APN (sl2sfr).

Il obtient les informations :
- l'adresse IP locale
- la qualit√© du signal (CSQ) 
- le CCID (carte SIM)
- l'op√©rateur.

Une fois ce information r√©cuperes on peut deconnecter le GPRS pour envoyer le SMS, puis le modem s'√©teint.

---

## Etape 3 : Prochaine √©tape du projet et objectifs 

#### Objectif Integrer LoRa


Objectif 1. Int√©gration SIM6000 avec le ESP32, connexion √† GRSP et envois d'un SMS vers l'utilisateur final ‚Üí R√©ussi‚úÖ
Objectif 2. Simuler les donnes & envoyer une requ√™te PHP vers un serveur web avec les donnes des ruches. En cours ‚è∏Ô∏è 

- simuler les donnes des ruches num√©riqument 
- preparer la requete php pour envoyer les donnes vers le site -> http://rucher.polytech.unice.fr/
- v√©rifier la bonne r√©ception des donnes. 

---

## Etape 4 : Simulation des donnes des ruches via ARDUINO IDE


```
//=========Partie traitement donnes ruches==============

// 1. Structure pour repr√©senter les donn√©es d'une ruche
struct rucheData {
  int id;
  float temperature;
  float poids;
};
// declaration de nombre total de ruche
const int  nrRuches = 10;
rucheData ruches[nrRuches]; 

//simuler les donnes 
void simulData(){
  for (int i =0; i<nrRuches; i++){
      ruches[i].id = i+1;
      ruches[i].temperature = random(0, 400) / 10.0; // du 0 √† 40;
      ruches[i].poids= random(100000, 400000) / 10.0; // du 10kg √† 30 kg
  }
}

String serializeData() {
  String payload = "[";
  for (int i = 0; i < nrRuches; i++) {
    payload += "{";
    payload += "\"id\":" + String(ruches[i].id) + ",";
    payload += "\"temp\":" + String(ruches[i].temperature) + ",";
    payload += "\"weight\":" + String(ruches[i].poids);
    payload += "}";
    if (i < nrRuches - 1) {
      payload += ",";
    }
  }
  payload += "]";
  return payload;
}
//======================================================
```

## Etape 5 : envoi du requete PHP vers le site 

pour envoier la requete PHP ver le site on utilise le **GPRS** qui est utilis√© pour la communication WEB et le IOT


**GPRS** c'est le protocole qui nous permet d'envoyer des requetes sur internet 

**le site HTTP(S)** est le site sur lequel on doit envoyer les donnes qu'on doit se connecter **via une adresse IP que le GPRS nous la donne une fois connect√©**

On va utiliser une requete HTTP(S) qui peut √™tre du type
- Post pour envoyer les donnes au serveur 
- Get pour recevoir les donnes du serveur. dans notre cas on peut envisager de recevoir une r√©ponse du serveur une fois toues les donnes r√©cues par le site.


LA SUITE : faire la requete HTTPS et l'envoier via le GPRS vers le site HTTP


