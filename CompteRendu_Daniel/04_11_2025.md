# üìù Compte Rendu ‚Äî CEBAN Daniel  
## S√©ance du 04/11/2025

---

## üéØ Objectifs de la s√©ance
- Tester le code fourni par l'√©quipe precedente et v√©rifier si on arrive √† receptioner les messages avec de la carte **ESP32** avec le module **SIM7000G**
- Debuger le code 
- Ameliorer le code existant 

---

## Etapes de la seance 

### Etape 1 : Televersement du code sur la carte ESP32 

Debugger de t√©lecharger le code sur la carte **ESP32 Heltec LoRa**

Le t√©l√©versement est le processus qui consiste √† compiler le code, le transformer en langage machine, puis √† le transf√©rer et l'√©crire dans la m√©moire flash de l'ESP32.
Une fois cette √©tape faite, on pourrait d√©marrer le d√©bogage.


- Lorsqu'on lance le t√©l√©chargement, on re√ßoit une erreur : 

```text
Connecting......................................
A fatal error occurred: Failed to connect to ESP32: Invalid head of packet (0x00): Possible serial noise or corruption.
For troubleshooting steps visit: https://docs.espressif.com/projects/esptool/en/latest/troubleshooting.html
```

![Error message ARDUINO IDE](../Images/Error04_11_2025.png)  

L'ESP32 doit √™tre mis manuellement en mode flash (ou boot) pour accepter un nouveau programme, bien que de nombreux kits de d√©veloppement modernes g√®rent cela automatiquement via les broches DTR et RTS de l'interface USB-s√©rie.
Proc√©dure :

Cliquez sur T√©l√©verser
Attendez que "Connecting..." apparaisse
Maintenez PRG enfonc√©
Rel√¢chez PRG lorsque vous voyez des points (....) ou une barre de progression

M√™me avec cette proc√©dure, on n'arrive pas √† t√©l√©charger le fichier sur la carte.
On d√©cide alors d'essayer de d√©brancher tous les c√¢bles de la carte.
Cette fois, le t√©l√©versement du code sur la carte **ESP32** non c√¢bl√©e fonctionne.

![Updading works ARDUINO IDE](../Images/UploadingWorks.png) 

On d√©cide alors qu'il y a un probl√®me de c√¢blage.
Apr√®s une analyse, on d√©cide de d√©brancher le c√¢ble **PWRKEY** et de retester, car il √©tait connect√© au 3,3 V. Alors que d'ap√®rs le data sheet elle doit √™tre connecte √† une tension <0.5V. On a du faire une erreur lors du c√¢blage
Par la suite on va brancher le **PWRKEY** √† un GPIO de commande pour pouvoir le piloter num√©riquement.

Cette fois √ßa marche : **on arrive √† t√©l√©charger le programme sur la carte ESP32 c√¢bl√©e**.

---

### Etape 2 : D√©bogage s√©rie et v√©rification de la communication s√©rie

√âtapes pour le D√©bogage S√©rie :

1. Appuyez sur le bouton RST pour red√©marrer l'ESP32.
2. Dans l'IDE Arduino, cliquez sur l'ic√¥ne de la Loupe (en haut √† droite) ou allez dans Outils > Moniteur S√©rie.
3. V√©rifiez la vitesse : Assurez-vous que la vitesse s√©lectionn√©e en bas du Moniteur S√©rie est bien 115200 baud pour correspondre √† votre ligne Serial.begin(115200).

on doit voir le programme s'ex√©cuter et afficher les messages que vous avez cod√©s, par exemple :

```text
Initialisation du modem...
```


#### R√©sultat 

Erreur du r√©demarrage du modem li√© √† la partie code

```text
rst:0x1 (POWERON_RESET),boot:0x17 (SPI_FAST_FLASH_BOOT)
configsip: 0, SPIWP:0xee
clk_drv:0x00,q_drv:0x00,d_drv:0x00,cs0_drv:0x00,hd_drv:0x00,wp_drv:0x00
mode:DIO, clock div:1
load:0x3fff0030,len:4980
load:0x40078000,len:16612
load:0x40080400,len:3480
entry 0x400805b4
Core dump data check failed:
Calculated checksum='00d9289a'
Image checksum='ffffffff'

Patientez...
Initialisation du modem...
ATE0
AT+CFUN=0
√âchec du red√©marrage du modem, tentative de continuation sans red√©marrage
AT+CGMI
AT+CGMM
Nom du modem : SIMCom SIM7000
ATI
Infos modem : 
AT+CPIN?
```

on cerchant dans le code on trouve la configuration des broches qu'on doit adapter √† la nouvelle carte. La le groupe d'avant ont utilis√© un autre carte . 


```text
#define UART_BAUD   115200
#define PIN_DTR     25
#define PIN_TX      20
#define PIN_RX      19
#define PWR_KEY     4
```

### Explication RT TX
Initialement on a prevu d'utiliser les pins **GPIO3** et **GPIO1** pour communiquer en s√©rier 
cependant ce deux pins sont utiliser pour la communication du **EPS32** avec le pc pour le t√©chechargement des donnes donc on va utiliser d'autres pourt 

on se propose utiliser le pins **21** et **23**



üìå R√¥le de PWR_KEY
Pour le modem SIM7000, le r√¥le de cette broche est de contr√¥ler l'alimentation ou le cycle de r√©initialisation du module modem :

D√©signation : Le PWR_KEY est destin√© √† √™tre c√¢bl√© √† la broche PWRKEY du module modem (SIM7000G).

Fonction : Il est utilis√© pour envoyer l'impulsion de d√©marrage ou d'arr√™t (l'√©quivalent d'appuyer et de maintenir le bouton d'alimentation) au modem.

Ancien C√¢blage : Dans la configuration que vous avez trouv√©e (avant l'Heltec), la carte ESP32 utilis√©e pr√©c√©demment avait d√©sign√© le GPIO 4 pour cette t√¢che.

| Broche de la Fonction | Ancienne D√©finition (Code) | Nouvelle D√©finition (Heltec WiFi LoRa 32) |
|----------------------|----------------------------|-------------------------------------------|
| TX (ESP32 -> SIM7000) | PIN_TX 20 | **PIN_TX 23** |
| RX (SIM7000 -> ESP32) | PIN_RX 11 | **PIN_RX 21** |
| Contr√¥le d'Alimentation | PWR_PIN 4 | **PWR_PIN 13** |
| Vitesse de Communication | UART_BAUD 115200 | **UART_BAUD 115200** |

#### Resultat
Avec cette config on n'arrive non plus a √©tablier une communication serie ESP32 et module GSM. on va donc procede √† l'analyse du code et modification...

---


### Etape 3 correction du code

Quelques modification dans le code actuel : 


Red√©marrage du modem
```	
if (!modem.restart()) { Serial.println("√âchec du red√©marrage du modem..."); } 
```

on va utiliser plut√¥t

```
modem.init();
```
Car modem.restart(); envoie un AT+CFUN=1,1 qui est plus invasif. modem.init() est souvent plus fiable pour initialiser la connexion AT apr√®s un cycle de d√©marrage physique.


#### Resultat 
M√™me erreur -> possible probl√®me -> mouvais c√¢blage
